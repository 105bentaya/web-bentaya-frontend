<div class="mt-2">
  <p-checkbox
    label="Selección Múltiple"
    class="flex-row-reverse mb-2 float-end"
    labelStyleClass="me-2 ms-0"
    [binary]="true"
    [(ngModel)]="multiple"
    [disabled]="loading"
    (onChange)="onSelectionCheckboxChange()"
  ></p-checkbox>
  @if (multiple) {
    <p-multiSelect
      [options]="groupedInfo"
      [group]="true"
      [(ngModel)]="selectedInfo"
      appendTo="body"
      styleClass="w-100"
      class="w-100 attendance-multiselect"
      panelStyleClass="attendance-multiselect"
      (onChange)="onMultipleSelect()"
      [showClear]="true"
      placeholder="Elegir personas educandas"
      filterBy="name,surname"
    >
      <ng-template let-group pTemplate="group">
      <div class="d-flex align-items-center">
        <a class="text-black cursor-pointer" (click)="onMultipleGroupSelect(group.items)">
          {{ group.attendLabel }}
        </a>
        <hr>
      </div>
    </ng-template>
      <ng-template let-scout pTemplate="item">
        <div style="overflow: hidden; text-overflow: ellipsis;">
          {{ scout.name }}, {{ scout.surname }}
        </div>
      </ng-template>
      <ng-template pTemplate="selectedItems">
        @if (selectedInfo) {
          <div style="overflow: hidden; text-overflow: ellipsis;">{{ selectedInfo | scouts }}</div>
        }
        @if (!selectedInfo || selectedInfo.length < 1) {
          <div>Elegir personas educandas</div>
        }
      </ng-template>
    </p-multiSelect>
  } @else {
    <p-autoComplete
      panelStyleClass="opacity: 1"
      placeholder="Elegir persona educanda"
      [suggestions]="filteredInfo"
      (completeMethod)="autocompleteFilterAttendance($event)"
      appendTo="body"
      styleClass="w-100 bold-placeholder"
      inputStyleClass="w-100"
      [inputStyle]="{'border-color': '#b9c1c8'}"
      [dropdown]="true"
      [forceSelection]="true"
      optionLabel="name"
      [showClear]="true"
      (onSelect)="onAutoCompleteSelect($event.value)"
      (onClear)="this.selectedConfirmation = undefined"
    >
      <ng-template let-scout pTemplate="item">
        <div style="overflow: hidden; text-overflow: ellipsis;">
          {{ scout.name }}, {{ scout.surname }}
          ({{ scout.attending == null ? 'NS/NC' : scout.attending ? 'Asiste' : 'No asiste' }})
        </div>
      </ng-template>
    </p-autoComplete>
  }
  @if (!multiple && selectedConfirmation) {
    <div class="d-flex flex-column gap-3 mt-2">
      <div class="d-flex flex-wrap justify-content-between gap-3">
        <div class="d-flex flex-column gap-1">
          <label>Asiste:</label>
          <p-selectButton
            [allowEmpty]="false"
            [options]="attendanceOptions"
            optionLabel="label"
            optionValue="value"
            [(ngModel)]="selectedConfirmation.attending"
          ></p-selectButton>
        </div>
        @if (hasPayment) {
          <div class="d-flex flex-column gap-1">
            <label>Ha pagado:</label>
            <p-selectButton
              [allowEmpty]="false"
              [options]="paymentOptions"
              optionLabel="label"
              optionValue="value"
              [(ngModel)]="selectedConfirmation.payed"
            ></p-selectButton>
          </div>
        }
      </div>
      <div class="d-flex flex-column gap-1">
        <label>Observaciones:</label>
        <app-form-text-area
          [maxLength]="1024"
          [(ngModel)]="selectedConfirmation.text"
          (isValid)="validText = $event"
        ></app-form-text-area>
      </div>
      <app-save-buttons
        [saveLoading]="loading"
        [saveDisabled]="!validText"
        (onSave)="onSingleSubmit(selectedConfirmation)"
      ></app-save-buttons>
    </div>
  } @else if (multiple && selectedInfo && selectedInfo.length > 0) {
    <div class="d-flex flex-column gap-3 mt-2">
      <label>Ha seleccionado {{ selectedInfo.length }} personas educandas, de las cuales:</label>
      <ul>
        @if (infoAttending > 0) {
          <li>{{ infoAttending }} asiste{{ infoAttending > 1 ? 'n' : '' }}</li>
        }
        @if (infoNotAttending > 0) {
          <li>{{ infoNotAttending }} no asiste{{ infoNotAttending > 1 ? 'n' : '' }}</li>
        }
        @if (infoNotConfirmed > 0) {
          <li>{{ infoNotConfirmed }} no ha{{ infoNotConfirmed > 1 ? 'n' : '' }}confirmado</li>
        }
        @if (hasPayment) {
          <hr>
          @if (infoPayed > 0) {
            <li>{{ infoPayed }} ha{{ infoPayed > 1 ? 'n' : '' }} pagado</li>
          }
          @if (infoNotPayed > 0) {
            <li>{{ infoNotPayed }} no ha{{ infoNotPayed > 1 ? 'n' : '' }} pagado</li>
          }
        }
      </ul>
      <div class="d-flex flex-wrap justify-content-between gap-3">
        <div class="d-flex flex-column gap-1">
          <label>Asisten:</label>
          <p-selectButton
            [allowEmpty]="false"
            [options]="attendanceOptions"
            optionLabel="label"
            optionValue="value"
            [(ngModel)]="multipleAttending"
          ></p-selectButton>
        </div>
        @if (hasPayment) {
          <div class="d-flex flex-column gap-1">
            <label>Han pagado:</label>
            <p-selectButton
              [allowEmpty]="false"
              [options]="multiplePaymentOptions"
              optionLabel="label"
              optionValue="value"
              [(ngModel)]="multiplePaying"
            ></p-selectButton>
          </div>
        }
      </div>
      <app-save-buttons
        [saveLoading]="loading"
        [saveDisabled]="multipleAttending === undefined"
        (onSave)="onMultipleSubmit()"
      ></app-save-buttons>
    </div>
  } @else {
    <div class="d-flex flex-column gap-3 mt-2 opacity-50">
      @if (multiple) {
        <label>Ha seleccionado 0 personas educandas, de las cuales:</label>
        <ul>
          <li>0 asisten</li>
          <li>0 no asisten</li>
          @if (hasPayment) {
            <hr>
            <li>0 han pagado</li>
          }
        </ul>
      }
      <div class="d-flex flex-column gap-1">
        <div class="d-flex flex-wrap justify-content-between gap-3">
          <div class="d-flex flex-column gap-1">
            <label>
              @if (multiple) {
                Asisten:
              } @else {
                Asiste:
              }
            </label>
            <p-selectButton
              [options]="attendanceOptions"
              optionLabel="label"
              [disabled]="true"
            ></p-selectButton>
          </div>
          @if (hasPayment) {
            <div class="d-flex flex-column gap-1">
              <label>
                @if (multiple) {
                  Han pagado:
                } @else {
                  Ha pagado:
                }
              </label>
              <p-selectButton
                [options]="multiple ? multiplePaymentOptions : paymentOptions"
                optionLabel="label"
                [disabled]="true"
              ></p-selectButton>
            </div>
          }
        </div>
      </div>
      @if (!multiple) {
        <div class="d-flex flex-column gap-1">
          <label>Observaciones:</label>
          <app-form-text-area
            [maxLength]="1024"
            (isValid)="validText = $event"
            [disabled]="true"
          ></app-form-text-area>
        </div>
      }
      <app-save-buttons [saveDisabled]="true"></app-save-buttons>
    </div>
  }
</div>
