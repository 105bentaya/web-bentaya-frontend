@if (formHelper.form) {
  <div class="mt-1">
    <form class="form-container" [formGroup]="formHelper.form">
      <div class="row">
        <div class="col-12 col-sm-6">
          <p-floatlabel variant="on">
            <input id="title" formControlName="title" pInputText>
            <label class="required" for="title">Título</label>
          </p-floatlabel>
        </div>
        <div class="col-12 col-sm-6">
          <div class="d-flex flex-column">
          <p-floatlabel variant="on">
            <p-select
              id="groupId"
              formControlName="groupId"
              [options]="groups"
              appendTo="body"
              optionLabel="name"
              optionValue="id"
              (onChange)="checkForDateConflicts()"
            ></p-select>
            <label class="required" for="groupId">Unidad</label>
          </p-floatlabel>
            <div class="mt-1">
              <app-checkbox-container label="Crear sólo para scouters">
                <p-check-box [binary]="true" formControlName="forScouters"></p-check-box>
              </app-checkbox-container>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-12 mb-2">
          <p-floatlabel variant="on">
            <label for="description">Descripción</label>
            <app-form-text-area
              id="description"
              formControlName="description"
              rows="4"
              [maxLength]="4095"
            ></app-form-text-area>
          </p-floatlabel>
        </div>
      </div>
      <div class="row mb-1">
        <div class="col-12 col-sm-6">
          <p-floatlabel variant="on">
            <p-datePicker
              id="startDate"
              formControlName="startDate"
              appendTo="body"
              [showTime]="!formHelper.controlValue('unknownTime')"
              [stepMinute]="5"
              [defaultDate]="defaultStartDate"
              [hideOnDateTimeSelect]="false"
              (onClose)="checkDate('endDate')"
              (onClear)="checkForDateConflicts()"
              [class]="formHelper.hasFormError('endDateBefore') ? 'ng-invalid ng-dirty' : ''"
              [showClear]="true"
            ></p-datePicker>
            <label class="required" for="startDate">Fecha de Inicio</label>
          </p-floatlabel>
        </div>
        <div class="col-12 col-sm-6">
          <p-floatlabel variant="on">
            <p-datePicker
              id="endDate"
              formControlName="endDate"
              appendTo="body"
              [showTime]="!formHelper.controlValue('unknownTime')"
              [stepMinute]="5"
              [defaultDate]="defaultEndDate"
              [hideOnDateTimeSelect]="false"
              (onClose)="checkDate('startDate')"
              (onClear)="checkForDateConflicts()"
              [class]="formHelper.hasFormError('endDateBefore') ? 'ng-invalid ng-dirty' : ''"
              [showClear]="true"
            ></p-datePicker>
            <label class="required" for="endDate">Fecha de Fin</label>
          </p-floatlabel>
        </div>
      </div>
      <div class="row mt-revert">
        <div class="col-12">
          <app-checkbox-container label="Hora sin especificar">
            <p-checkbox formControlName="unknownTime" [binary]="true" (onChange)="checkForDateConflicts()"></p-checkbox>
          </app-checkbox-container>
        </div>
        @if (dateCoincidences.length > 0) {
          <p-message severity="warn" class="mt-1 mb-3">
            Las fechas del evento coinciden con el inicio o fin de las actividades de otras unidades:
            <ul>
              @for (group of dateCoincidences; track group.id) {
                <li>{{ group.name }}</li>
              }
            </ul>
            <p>
              Revisa en el calendario los lugares y horas de estas unidades (haciendo click en
              <i class="pi pi-globe align-middle"></i>) para evitar conflictos de lugar y horario (y que las familias no
              tengan que teletransportarse).
            </p>
          </p-message>
        }
      </div>
      <div class="row mb-1">
        <div class="col-12 mb-0">
          <p-floatlabel variant="on">
            <input id="location" formControlName="location" pInputText>
            <label for="location">Lugar</label>
          </p-floatlabel>
        </div>
      </div>
      @if (formHelper.controlValue('location')) {
        <div class="row">
          <div class="col-12">
            <app-checkbox-container label="Especificar lugares de quedada y recogida">
              <p-checkbox [binary]="true" formControlName="specifyLocations"></p-checkbox>
            </app-checkbox-container>
          </div>
        </div>
      }
      @if (formHelper.controlValue("specifyLocations") && formHelper.controlValue('location')) {
        <div class="row">
          <div class="col-12 col-sm-6">
            <p-floatlabel variant="on">
              <input
                pInputText
                id="meetingLocation"
                formControlName="meetingLocation"
              >
              <label class="required" for="meetingLocation">Quedada</label>
            </p-floatlabel>
          </div>
          <div class="col-12 col-sm-6">
            <p-floatlabel variant="on">
              <input
                pInputText
                id="pickupLocation"
                formControlName="pickupLocation"
              >
              <label class="required" for="pickupLocation">Recogida</label>
            </p-floatlabel>
          </div>
        </div>
      }
      @if (showAttendanceCheckbox()) {
        <div class="row">
          @if (!formHelper.controlValue('activateAttendanceList')) {
            <div class="col-12">
              <app-checkbox-container label="Activar asistencia">
                <p-checkbox [binary]="true" formControlName="activateAttendanceList"></p-checkbox>
              </app-checkbox-container>
            </div>
          }
          @if (formHelper.controlValue('activateAttendanceList')) {
            <div class="col-12 mt-2">
              <p-panel header="Ajustes de asistencia" class="attendance-panel w-100" toggleable>
                <div class="d-flex flex-column gap-2">
                  <app-checkbox-container label="Activar asistencia">
                    <p-checkbox [binary]="true" formControlName="activateAttendanceList"></p-checkbox>
                  </app-checkbox-container>
                  <app-checkbox-container label="Activar pago">
                    <p-checkbox [binary]="true" formControlName="activateAttendancePayment"></p-checkbox>
                  </app-checkbox-container>
                </div>
                <div class="mt-2">
                  <span>Fecha de cierre:</span>
                  <div class="d-flex flex-column gap-1">
                    <app-radio-button-container label="Cerrar al final del evento">
                      <p-radio-button formControlName="closeAttendanceMode" value="end"></p-radio-button>
                    </app-radio-button-container>
                    <app-radio-button-container label="Cerrar ahora">
                      <p-radio-button formControlName="closeAttendanceMode" value="now"></p-radio-button>
                    </app-radio-button-container>
                    <app-radio-button-container label="Determinar fecha de cierre">
                      <p-radio-button formControlName="closeAttendanceMode" value="date"></p-radio-button>
                    </app-radio-button-container>
                    @if (formHelper.controlValue('closeAttendanceMode') === 'date') {
                      <p-datePicker
                        appendTo="body"
                        id="closeDateTime"
                        formControlName="closeDateTime"
                        [showTime]="true"
                        [defaultDate]="formHelper.controlValue('endDate') ?? defaultEndDate"
                        [stepMinute]="5"
                        [hideOnDateTimeSelect]="false"
                        [class]="formHelper.isDirtyAndInvalid() && formHelper.hasFormError('closeDateNeeded') ? 'ng-invalid ng-dirty' : ''"
                      ></p-datePicker>
                    }
                  </div>
                </div>
              </p-panel>
            </div>
          }
        </div>
      }
      <div class="d-flex align-items-center flex-column justify-content-center gap-1">
        @if (formHelper.hasFormError("endDateBefore")) {
          <small class="text-danger">La fecha de fin debe ser posterior a la de inicio</small>
        }
          <app-save-buttons
            cancelLabel="Borrar"
            [showCancelButton]="!!this.existingEvent"
            [cancelLoading]="deleteLoading"
            (onCancel)="confirmDeletion()"
            [saveLoading]="saveLoading"
            (onSave)="onSubmit()"
          ></app-save-buttons>
        </div>
    </form>
  </div>
} @else {
  <app-basic-loading-info></app-basic-loading-info>
}
