<div>
  <div class="d-flex gap-2 align-items-center mb-1">
    <h2 class="mb-0 fw-bold fs-5 text-dark">Datos</h2>
    <p-button
      [label]="showMoreData ? 'Mostrar menos' : 'Mostrar más'"
      (onClick)="queryShowMoreData()"
      styleClass="py-1"
      outlined
      severity="secondary"
      size="small"
    ></p-button>
  </div>
  <div class="d-flex flex-column gap-3">
    <div class="info-container">
      <div class="row">
        <div class="col-12 col-sm-6 col-xl-3">
          <b>Nombre de la asociación</b>
          <div>{{ booking.organizationName }}</div>
        </div>
        <div class="col-12 col-sm-6 col-xl-3">
          <b>CIF de la asociación</b>
          <div>{{ booking.cif }}</div>
        </div>
        <div class="col-12 col-lg-6">
          <b>Fecha de solicitud</b>
          <div>{{ booking.creationDate | date:"dd/MM/yyyy HH:mm:ss" }}</div>
        </div>
        <div class="col-12 col-sm-6 col-xl-3">
          <b>Nombre contacto</b>
          <div>{{ booking.contactName }}</div>
        </div>
        <div class="col-12 col-sm-6 col-xl-3">
          <b>Relación</b>
          <div>{{ booking.contactRelationship }}</div>
        </div>
        <div class="col-12 col-sm-6 col-xl-3">
          <b>Correo</b>
          <div class="overflow-ellipsis">
            <a href="mailto:{{booking.contactMail}}">{{ booking.contactMail }}</a>
          </div>
        </div>
        <div class="col-12 col-sm-6 col-xl-3">
          <b>Teléfono</b>
          <div>
            <a href="tel:{{booking.contactPhone}}">{{ booking.contactPhone }}</a>
          </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
          <b>Número de participantes</b>
          <div>{{ booking.packs }}</div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
          <b>Fecha de entrada</b>
          <div>{{ booking.startDate | date:"dd/MM/yyyy HH:mm" }}</div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
          <b>Fecha de salida</b>
          <div>{{ booking.endDate | date:"dd/MM/yyyy HH:mm" }}</div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
          <b>Días</b>
          <div>{{ booking.billableDays }} ({{ booking.minutes | hour }})</div>
        </div>
        <div class="col-12 col-lg-6">
          @if (booking.status === 'OCCUPIED') {
            <b>Centro en exclusividad</b>
          } @else {
            <b>Solicita centro en exclusividad</b>
          }
          <div>
            {{ booking.exclusiveReservation ? 'Sí' : 'No' }}
            @if (bookingIsAlwaysExclusive(booking)) {
              (Siempre es exclusivo)
            }
          </div>
        </div>
        @if (booking.price) {
          <div class="col-12 col-lg-6">
            <b>Precio establecido</b>
            <div>{{ booking.price | currency:'EUR':undefined:undefined:'es' }}</div>
          </div>
        }
        <div class="col-12">
          <b>Observaciones</b>
          <div>{{ booking.observations || 'Ninguna' }}</div>
        </div>
        @if (showMoreData) {
          <div class="col-12">
            <b>Uso de instalaciones</b>
            <div>{{ booking.facilityUse }}</div>
          </div>
        }
      </div>
    </div>
    <div>
      <div class="d-flex flex-wrap gap-2 align-items-center">
        <h2 class="mb-0 fw-bold fs-5 text-dark">Estado actual</h2>
        <p-tag
          [value]="booking.status | bookingStatus"
          [severity]="booking.status | bookingStatus:'severity'"
          styleClass="fs-6 rounded-3"
        />
      </div>
      <div class="d-flex flex-column gap-1 align-items-start mt-2">
        @switch (booking.status) {
          @case ('CANCELED') {
            <div>La persona solicitante ha cancelado la reserva por el siguiente motivo:</div>
            <span>{{ booking.statusObservations }}</span>
          }
          @case ('REJECTED') {
            <div>
              <b>Motivo de la denegación:</b>
              <div>{{ booking.statusObservations }}</div>
            </div>
          }
          @case ('RESERVED') {
            <div>
              @if (booking.userConfirmedDocuments) {
                La persona solicitante <b>ya ha confirmado sus documentos</b>.
              } @else {
                La persona solicitante <b>aún no ha confirmado sus documentos</b>.
              }
            </div>
          }
        }
      </div>
    </div>
    <div>
      <div class="d-flex gap-2 align-items-center flex-wrap">
        <h2 class="mb-0 fw-bold fs-5 text-dark">Acciones</h2>
        @if (booking.status != Status.REJECTED && booking.status != Status.CANCELED) {
          @if (booking.status == Status.NEW) {
            <ng-container *ngTemplateOutlet="actionButton; context: {$implicit: buttonsInfo['accept']}"/>
          } @else if (booking.status == Status.RESERVED) {
            <ng-container *ngTemplateOutlet="actionButton; context: {$implicit: buttonsInfo['confirm']}"/>
            <ng-container *ngTemplateOutlet="actionButton; context: {$implicit: buttonsInfo['warn']}"/>
          }
          <ng-container *ngTemplateOutlet="actionButton; context: {$implicit: buttonsInfo['reject']}"/>
        } @else {
          <p-tag severity="secondary" value="No hay acciones disponibles" styleClass="rounded-3"/>
        }
      </div>
    </div>
    <div>
      <div class="d-flex gap-2 align-items-center">
        <h2 class="mb-0 fw-bold fs-5 text-dark">Documentos</h2>
        @if (files.length > 0) {
          <p-button
            [label]="showDocuments ? 'Ocultar' : 'Mostrar'"
            (onClick)="showDocuments = !showDocuments"
            styleClass="py-1"
            outlined
            severity="secondary"
            size="small"
          />
        }
        <p-button
          outlined
          icon="fa-solid fa-file-circle-question"
          severity="secondary"
          size="small"
          (click)="dialogVisible = true"
        />
      </div>
      <div class="mt-3">
        @if (showDocuments) {
          @for (file of files; track $index) {
            <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 py-2 border-bottom">
            <span>{{ file.fileName }} -
              <b
                class="rounded-1 p-1"
                [class]="file.status | documentStatus:true"
                [innerText]="file.status | documentStatus"
              ></b>
            </span>
              <div class="d-flex gap-2">
                <app-table-icon-button
                  icon="pi pi-download"
                  [disabled]="loading"
                  (click)="downloadFile(file)"
                  title="Descargar"
                ></app-table-icon-button>
                @if (file.fileName.endsWith('pdf')) {
                  <app-table-icon-button
                    icon="pi pi-eye"
                    severity="info"
                    [disabled]="loading"
                    (click)="showFile(file)"
                    title="Abrir"
                  ></app-table-icon-button>
                }
                <app-table-icon-button
                  icon="pi pi-trash"
                  severity="danger"
                  [disabled]="loading"
                  (click)="deleteFile(file)"
                  title="Borrar"
                ></app-table-icon-button>
                <app-table-icon-button
                  icon="pi pi-check"
                  severity="success"
                  [disabled]="loading"
                  (click)="updateFile(file, 'ACCEPTED')"
                  title="Marcar como válido"
                ></app-table-icon-button>
                <app-table-icon-button
                  icon="pi pi-times"
                  severity="danger"
                  [disabled]="loading"
                  (click)="updateFile(file, 'REJECTED')"
                  title="Marcar como inválido"
                ></app-table-icon-button>
              </div>
            </div>
          }
        } @else {
          <p-tag severity="secondary" styleClass="rounded-3">
            @if (files.length == 0) {
              No hay ningún documento asociado
            } @else if (files.length == 1) {
              Hay 1 documento asociado
            } @else if (files.length > 1) {
              Hay {{ files.length }} documentos asociados
            }
          </p-tag>
        }
      </div>
    </div>
  </div>

</div>
<p-dialog
  header="Documentos que nos tienen que entregar"
  [(visible)]="dialogVisible"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  styleClass="basic-dialog"
>
  <ul>
    @for (document of documents; track $index) {
      <li>
        {{ document.name }}
        @if (document.attendance) {
          <a class="link cursor-pointer" (click)="downloadAttendanceFile(booking.scoutCenter.id)">(Puede descargarlo
            aquí)</a>.
        }
      </li>
    }
  </ul>
</p-dialog>

<ng-template #actionButton let-info>
  <p-button
    class="d-none d-sm-block"
    styleClass="py-1 px-2 gap-1 border-2"
    [icon]="info.icon"
    [label]="info.label"
    [severity]="info.severity"
    outlined
    [loading]="loading"
    (click)="info.action()"
  ></p-button>
  <p-button
    size="small"
    class="d-sm-none"
    styleClass="border-2"
    [icon]="info.icon"
    [severity]="info.severity"
    outlined
    [loading]="loading"
    (click)="info.action()"
  ></p-button>
</ng-template>
